name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.4)'
        required: true
        default: '0.4'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Restore dependencies
      run: dotnet restore WindowsEdgeLight/WindowsEdgeLight.csproj
      
    - name: Build x64
      run: |
        dotnet publish WindowsEdgeLight/WindowsEdgeLight.csproj `
          -c Release `
          -r win-x64 `
          /p:DebugType=None `
          /p:DebugSymbols=false `
          --self-contained
          
    - name: Build ARM64
      run: |
        dotnet publish WindowsEdgeLight/WindowsEdgeLight.csproj `
          -c Release `
          -r win-arm64 `
          /p:DebugType=None `
          /p:DebugSymbols=false `
          --self-contained
          
    - name: Prepare artifacts
      run: |
        New-Item -ItemType Directory -Path artifacts -Force
        $version = "${{ github.ref_name }}" -replace '^v', ''
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        }
        
        # Copy EXE files
        Copy-Item "WindowsEdgeLight/bin/Release/net10.0-windows/win-x64/publish/WindowsEdgeLight.exe" `
                  "artifacts/WindowsEdgeLight-v$version-win-x64.exe"
        Copy-Item "WindowsEdgeLight/bin/Release/net10.0-windows/win-arm64/publish/WindowsEdgeLight.exe" `
                  "artifacts/WindowsEdgeLight-v$version-win-arm64.exe"
        
        # Create ZIP files for portable versions
        Compress-Archive -Path "WindowsEdgeLight/bin/Release/net10.0-windows/win-x64/publish/*" `
                        -DestinationPath "artifacts/WindowsEdgeLight-v$version-win-x64.zip"
        Compress-Archive -Path "WindowsEdgeLight/bin/Release/net10.0-windows/win-arm64/publish/*" `
                        -DestinationPath "artifacts/WindowsEdgeLight-v$version-win-arm64.zip"
                  
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: WindowsEdgeLight-Release
        path: |
          artifacts/*.exe
          artifacts/*.zip
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/*.exe
          artifacts/*.zip
        body: |
          ## Windows Edge Light ${{ github.ref_name }}
          
          A lightweight WPF application that adds a customizable glowing edge light effect around your primary monitor.
          
          ### ðŸ“¦ Downloads
          
          Choose the version for your Windows architecture:
          
          **Single-File Executables** (recommended for most users):
          - **WindowsEdgeLight-${{ github.ref_name }}-win-x64.exe** - For Intel/AMD 64-bit Windows (~75MB)
          - **WindowsEdgeLight-${{ github.ref_name }}-win-arm64.exe** - For ARM64 Windows (Surface Pro X, etc.) (~71MB)
          
          **Portable ZIP Packages** (for advanced users with auto-update support):
          - **WindowsEdgeLight-${{ github.ref_name }}-win-x64.zip** - Portable x64 version
          - **WindowsEdgeLight-${{ github.ref_name }}-win-arm64.zip** - Portable ARM64 version
          
          All versions are self-contained - no .NET installation required!
          
          ### âœ¨ What's New
          
          - **Automatic Updates**: Built-in update checker notifies you of new versions
          - **One-Click Install**: Download and install updates directly from the app
          - **Release Notes**: View what's new before updating
          
          ### ðŸš€ Features
          
          - **Global Hotkeys**: Control from any application
            - `Ctrl+Shift+L` - Toggle light on/off
            - `Ctrl+Shift+â†‘` - Increase brightness
            - `Ctrl+Shift+â†“` - Decrease brightness
          - **System Tray Icon**: Right-click for menu with all options
          - **Primary Monitor Display**: Automatically detects and fits your main screen
          - **DPI Aware**: Works perfectly on 4K displays
          - **Click-Through**: Won't interfere with your work
          
          Created by Scott Hanselman
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
